
# coding: utf-8

# # PyHSMM Sandbox
# ---

# ---
#
# This notebook serves to provide a sandbox environment to experiment with the pyhsmm package and hence Bayesian inference for Hidden Semi-Markov Models.

# In[4]:


import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from pyhsmm.basic.distributions import PoissonDuration
from pyhsmm.models import WeakLimitHDPHSMM, HSMM
from pybasicbayes.distributions.gaussian import Gaussian
from pybasicbayes.distributions.multinomial import Categorical
from pybasicbayes.distributions.mixturedistribution import DistributionMixture
import pickle
from pyhsmm.util.eaf_processing import to_eaf




# ---
#
# ## Single Sequence Experiments
#
# First, we will consider a single sequence to perform inference on. This should yield in the frequentist setting the same results as those obtained by using the hsmmlearn package.
#
# ### Data  Input

# We first read in the symbol sequence being our observations. To this end we have stored the symbol sequence for the run 692 as a csv file. Note that the zSymbols refer to the respective combination of the categorical observables as defined in the iterate_v3 config yaml.

# In[3]:

import sys
sys.path.append('/home/daniel/PycharmProjects/Projects/virtamed_3_6')

"""
the following data files are given in the obs_records dictionary and the 
decoded_df object:

'Data/2018_01_18_13_45_22_022/2018_01_18_13_45_22_022.eaf'
'Data/2018_01_18_12_57_05_692/2018_01_18_12_57_05_692_1.eaf'
'Data/2018_01_18_12_42_56_973/2018_01_18_12_42_56_973.eaf'
'Data/2018_01_18_12_47_42_257/2018_01_18_12_47_42_257.eaf'
'Data/2018_01_18_12_51_23_562/2018_01_18_12_51_23_562.eaf'
'Data/2018_01_18_13_01_17_229/2018_01_18_13_01_17_229.eaf'
"""

pickle_in = open("./obs_records_dict.p","rb")
obs_records_dict = pickle.load(pickle_in)

obs_list = obs_records_dict["obs"]
records = obs_records_dict["records"]

pickle_in = open("./decode_df.p", "rb")
decode_df = pd.read_pickle("./decode_df.p")




# ### Definition of initial parameters

# In[7]:


Nmax = None
obs_dim = 4

state_list = ["DX", "place_tool", "cutting_loop", "coag_loop", "clear_view", "handle_chips"]
trans_matrix = [
  [0.000, 0.760, 0.010, 0.010, 0.210, 0.010],       #DX
  [0.010, 0.000, 0.430, 0.430, 0.120, 0.010],       #place tool
  [0.010, 0.450, 0.000, 0.250, 0.250, 0.040],       #cutting loop
  [0.010, 0.530, 0.210, 0.000, 0.200, 0.050],       #coag loop
  [0.010, 0.450, 0.200, 0.250, 0.000, 0.050],       #clear view
  [0.010, 0.060, 0.015, 0.015, 0.900, 0.000]        #handle chips
  ]


# Initial state distribution prior
pi_0 = [0.990, 0.002, 0.002, 0.002, 0.002, 0.002]

# Parameters for the duration distribution (Gamma prior for a Poisson distribution)
alpha_0s = [4.8, 1.0, 0.5, 1.0, 1.7, 4.0]
beta_0s = [0.01, 0.01, 0.01, 0.01, 0.01, 0.01]

# Parameters for the Gaussian emission distribution of the continuous observables
mu_0s = [[-0.00153264,-0.04537947,-0.02625606],
         [0.01677362,-0.05283357,-0.05239786],
         [-0.00229492,0.02923637,0.03890725],
         [0.20052574,0.04940714,-0.07683169],
         [-0.01527346,-0.02078213,0.02857407],
         [0.06600041,0.16879629,0.05148763]]

sigma_0s = [[[4.72930231e-01,2.43618309e-02,6.44149858e-03],
              [2.43618309e-02,1.59940769e-01,4.41889207e-02],
              [6.44149858e-03,4.41889207e-02,2.99600381e-01]],

             [[1.32391372e-01,1.68389855e-02,1.34488169e-02],
              [1.68389855e-02,1.07246191e-01,3.01391374e-02],
              [1.34488169e-02,3.01391374e-02,1.76619888e-01]],

             [[6.00011833e-02,-1.12897590e-04,-7.41909106e-04],
              [-1.12897590e-04,5.14267897e-02,-1.24109720e-03],
              [-7.41909106e-04,-1.24109720e-03,7.34008519e-02]],

             [[1.87182998e-01,8.10472330e-03,-3.87681125e-02],
              [8.10472330e-03,5.12437949e-02,-1.92794279e-03],
              [-3.87681125e-02,-1.92794279e-03,6.75327843e-02]],

             [[2.94168504e-01,-2.66189531e-02,-3.09086863e-03],
              [-2.66189531e-02,1.38492736e-01,-1.36803256e-02],
              [-3.09086863e-03,-1.36803256e-02,1.46398883e-01]],

             [[2.68716849e-01,-2.42227143e-01,1.49313662e-01],
              [-2.42227143e-01,1.15183681e+00,7.76968373e-02],
              [1.49313662e-01,7.76968373e-02,7.02026769e-01]]]

kappa_0 = 0.3
nu_0 = obs_dim+4

alpha_0 = 5

weights = [[1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,7.21831662e-02,9.25435058e-02,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,6.30786370e-02,1.28346971e-01,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.92078675e-04,1.63305290e-01,4.44815797e-01],
           [4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,9.05871696e-02,9.01754097e-02,3.32701968e-02,4.37288973e-02,4.11759862e-04,4.11759862e-04,4.11759862e-04,6.56345219e-02,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,2.47055917e-03,2.05879931e-03,4.11759862e-04,3.62348678e-03,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,2.47055917e-02,2.43761838e-02,1.11175163e-02,8.56460512e-03,4.11759862e-04,4.11759862e-04,4.11759862e-04,1.43127728e-01,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,1.16939801e-02,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.94111834e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,5.47640616e-02,9.31400807e-02,4.11759862e-04,1.97644734e-02,4.11759862e-04,4.11759862e-04,4.11759862e-04,7.08226962e-02,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-03,7.74108540e-03,4.11759862e-04,1.42468912e-02,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,3.12937495e-03,3.70583875e-03,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.44700651e-02,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,4.11759862e-04,6.01169398e-02],
           [1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.38888889e-02,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,4.35323383e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,8.25041459e-02,9.49419569e-02,2.86069652e-02,4.66417910e-01,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,9.53565506e-03,1.03648425e-03,1.92786070e-02,7.87728027e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.49253731e-02,1.57545605e-02,1.03648425e-03,4.31177446e-02,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.32669983e-02,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03,1.03648425e-03],
           [1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,3.18206973e-02,3.90149419e-02,1.38350858e-03,1.36137244e-01,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,4.42722745e-03,1.38350858e-03,1.66021029e-03,1.78195905e-01,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,9.13115661e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,5.11898174e-02,1.38350858e-03,1.53569452e-01,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,3.79081350e-02,2.15827338e-02,1.38350858e-03,7.94133924e-02,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,8.30105147e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03,1.38350858e-03],
           [2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.45113370e-01,3.63006813e-02,3.85345694e-03,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,7.81860829e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,8.09225958e-02,2.66949626e-02,3.64123757e-02,2.71417402e-02,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,3.23913772e-03,2.79236010e-04,9.60571875e-03,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.66223612e-01,3.12185859e-02,3.92605830e-02,8.37708031e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,8.53345247e-02,2.21713392e-02,3.17770580e-02,4.52362337e-03,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04,2.79236010e-04],
           [9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,4.45847685e-02,9.56754688e-04,4.97512438e-02,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,2.12973594e-01,9.56754688e-04,4.95598928e-02,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,1.56142365e-01,9.56754688e-04,6.54420207e-02,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,2.87026406e-03,1.43130501e-01,9.56754688e-04,1.00459242e-01,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04,9.56754688e-04]]


# After setting the parameters and implementing a MixtureDistribution in the pybasicbayes package we can start defining our HSMM.

# In[13]:


dur_distns = []
gaussians = []
categoricals = []
mixtures = []
alpha_0s = np.array(alpha_0s)
beta_0s = np.array(beta_0s)
mu_0s = np.array(mu_0s)
sigma_0s = np.array(sigma_0s)
weights = np.array(weights)

dist_obs_map = [0,0,0,1]

for state in range(len(state_list)):
    dur_distns.append(PoissonDuration(alpha_0=alpha_0s[state], beta_0=beta_0s[state]))
    gaussians.append(Gaussian(mu_0 = mu_0s[state], sigma_0 = sigma_0s[state], kappa_0 = kappa_0, nu_0=nu_0))
    categoricals.append(Categorical(weights=weights[state,:],K = weights.shape[1], alpha_0=5))
    mixtures.append(DistributionMixture(distv = [gaussians[-1], categoricals[-1]], dist_obs_map=dist_obs_map))

distv = [gaussians, categoricals]

tmat = [
  [0.000, 0.760, 0.010, 0.010, 0.210, 0.010],       #DX
  [0.010, 0.000, 0.430, 0.430, 0.120, 0.010],       #place tool
  [0.010, 0.450, 0.000, 0.250, 0.250, 0.040],       #cutting loop
  [0.010, 0.530, 0.210, 0.000, 0.200, 0.050],       #coag loop
  [0.010, 0.450, 0.200, 0.250, 0.000, 0.050],       #clear view
  [0.010, 0.060, 0.015, 0.015, 0.900, 0.000]        #handle chips
  ]

pi_0 = [0.990, 0.002, 0.002, 0.002, 0.002, 0.002]

posteriormodel = HSMM(obs_distns=mixtures, dur_distns=dur_distns, trans_matrix=tmat,
                      pi_0=pi_0, alpha=1., init_state_concentration=1.)
posteriormodel.add_data(np.array(obs_list[1]))

from pyhsmm.util.text import progprint_xrange

print('Gibbs sampling for initialization')

for idx in progprint_xrange(25):
    posteriormodel.resample_model()

plt.figure()
posteriormodel.plot()
plt.gcf().suptitle('Gibbs-sampled initialization')

print('EM')

likes = posteriormodel.EM_fit()

state_seq = posteriormodel.stateseqs[0]
states = ["DX", "place_tool", "cutting_loop", "coag_loop", "clear_view", "handle_chips"]
eaf_file = "/home/daniel/PycharmProjects/Projects/virtamed_3_6/Data/2018_01_18_12_57_05_692/2018_01_18_12_57_05_692_1.eaf"
to_eaf(state_seq,  decode_df[1],  states, eaf_file, output_dir=".")

plt.figure()
posteriormodel.plot()
plt.gcf().suptitle('EM fit')

plt.figure()
plt.plot(likes)
plt.gcf().suptitle('log likelihoods during EM')

plt.show()



